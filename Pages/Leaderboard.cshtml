@page
@model NoodlesSimulator.Pages.LeaderboardModel
@{
    ViewData["Title"] = "×˜×‘×œ×ª ××•×‘×™×œ×™×";
}

<head>
    <meta charset="utf-8" />
    <title>Noodles Simulator â€” ×˜×‘×œ×ª ××•×‘×™×œ×™×</title>
    <link rel="stylesheet" href="/css/site.css" />
    <link rel="icon" type="image/png" sizes="32x32" href="/logo/noodles-logo-transparent.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/logo/noodles-logo-transparent.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/logo/noodles-logo-transparent.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#222222">
</head>

<!-- background -->
<img src="/assets/background.gif" alt="×¨×§×¢" class="background-gif" />

<!-- logo -->
<div class="logo-header">
    <a href="/Index" style="display:inline-block;">
        <img src="/logo/noodles-logo-transparent.png" alt="Noodles Simulator Logo" />
    </a>
</div>

<!-- back to quiz button -->
<form method="get" action="/Index" style="position: fixed; top: 20px; left: 20px;">
    <button type="submit" class="logout-btn">â¬… ×—×–×¨×” ×œ×—×™×“×•×Ÿ</button>
</form>

<!-- leaderoard -->
<div class="quiz-container" style="text-align:center;">
    <h2 style="margin-bottom: 5px;">ğŸ† ×˜×‘×œ×ª ×”××•×‘×™×œ×™×</h2>
    <div id="last-update" style="font-size: 12px; color: #888; margin-bottom: 20px;">(××ª×¢×“×›×Ÿ...)</div>

    <table id="leaderboard-table" style="width: 100%; border-collapse: collapse; margin-top: 10px; color: white; direction: ltr; text-align: left; margin-left: 0; margin-right: auto;">
        <thead>
            <tr style="background-color: #333;">
                <th style="padding: 12px; text-align: left; direction: ltr;">#</th>
                <th style="padding: 12px; text-align: left; direction: ltr;">×©× ××©×ª××©</th>
                <th style="padding: 12px; text-align: left; direction: ltr;">×ª×©×•×‘×•×ª × ×›×•× ×•×ª</th>
            </tr>
        </thead>
        <tbody>
        @for (int i = 0; i < Model.SortedUsers.Count; i++)
        {
            var user = Model.SortedUsers[i];
            var isCurrentUser = user.Username == Model.CurrentUsername;
            <tr style="background-color:@(i % 2 == 0 ? "#222" : "#111");">
                <td style="padding: 10px; text-align: left; direction: ltr;">@(@i + 1)</td>
                <td style="padding: 10px; text-align: left; direction: ltr;">
                    @{
                        var isOnline = user.LastSeen != null && user.LastSeen > DateTime.UtcNow.AddMinutes(-5);
                    }
                    @if (isOnline)
                    {
                        <strong style="color: #00ff00;">@user.Username</strong>
                    }
                    else
                    {
                        @user.Username
                    }
                </td>
                <td style="padding: 10px; text-align: left; direction: ltr;">@user.CorrectAnswers</td>
            </tr>
        }
        </tbody>
    </table>
</div>

<script>
let updateInterval;
let clockInterval;

async function fetchLeaderboardData() {
    try {
        const response = await fetch('/api/leaderboard-data?_=' + new Date().getTime());
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Only update if we have valid data
        if (data && data.users && Array.isArray(data.users)) {
            updateLeaderboardTable(data.users, data.currentUsername);
            
            // Update last update time baseline (smooth clock will refresh separately)
            window.__lastUpdateAt = Date.now();
        } else {
            console.warn('Invalid data received from server');
        }
        
    } catch (error) {
        console.warn('Failed to fetch leaderboard data:', error);
        // Don't clear the table on error, just show error message
        document.getElementById('last-update').textContent = '(×©×’×™××” ×‘×¢×“×›×•×Ÿ - ××—×›×”...)';
    }
}

function updateLeaderboardTable(data, currentUsername) {
    const table = document.getElementById('leaderboard-table');
    if (!table) return;
    
    // Keep header row, remove data rows
    const headerRow = table.querySelector('thead tr');
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    
    // Add new data rows
    data.forEach((user, index) => {
        const row = tbody.insertRow();
        row.style.backgroundColor = index % 2 === 0 ? '#222' : '#111';
        
        // Rank
        const rankCell = row.insertCell();
        rankCell.style.padding = '10px';
        rankCell.style.textAlign = 'left';
        rankCell.style.direction = 'ltr';
        rankCell.textContent = user.rank;
        
        // Username
        const usernameCell = row.insertCell();
        usernameCell.style.padding = '10px';
        usernameCell.style.textAlign = 'left';
        usernameCell.style.direction = 'ltr';
        
        if (user.isOnline) {
            const strongElement = document.createElement('strong');
            strongElement.style.color = '#00ff00';
            strongElement.textContent = user.username;
            usernameCell.appendChild(strongElement);
        } else {
            usernameCell.textContent = user.username;
        }
        
        // Correct answers
        const correctCell = row.insertCell();
        correctCell.style.padding = '10px';
        correctCell.style.textAlign = 'left';
        correctCell.style.direction = 'ltr';
        correctCell.textContent = user.correctAnswers;
    });
}

// Start auto-update every 3 seconds
function startAutoUpdate() {
    updateInterval = setInterval(fetchLeaderboardData, 200);
    // Smooth clock every 200ms
    if (!clockInterval) {
        clockInterval = setInterval(() => {
            const el = document.getElementById('last-update');
            if (!el) return;
            const t = window.__lastUpdateAt || Date.now();
            const now = new Date();
            // Show current time ticking regardless of fetch cadence
            el.textContent = `(×¢×•×“×›×Ÿ ×‘-${now.toLocaleTimeString('he-IL')})`;
        }, 200);
    }
}

// Stop auto-update
function stopAutoUpdate() {
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
    }
    if (clockInterval) {
        clearInterval(clockInterval);
        clockInterval = null;
    }
}

// Start updates when page loads
window.addEventListener('load', () => {
    fetchLeaderboardData(); // Initial load
    startAutoUpdate();
});

// Stop updates when page is hidden (to save resources)
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        stopAutoUpdate();
    } else {
        startAutoUpdate();
    }
});
</script>

<footer class="site-footer">
    <p class="text-sm text-muted-foreground">
        ×¤×•×ª×— ×¢×´×™ <a href="https://www.linkedin.com/in/yaniv-bahalul/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 hover:text-primary transition-colors">
            ×™× ×™×‘ ×‘×”×œ×•×œ
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-linkedin h-4 w-4">
                <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                <rect width="4" height="12" x="2" y="9"></rect>
                <circle cx="4" cy="4" r="2"></circle>
            </svg>
        </a> â€¢ ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª Â©
    </p>
</footer>
