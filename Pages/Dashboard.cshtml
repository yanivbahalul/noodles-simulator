@page
@model NoodlesSimulator.Pages.DashboardModel
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>Noodles Simulator — 🔧 ממשק ניהול</title>
    <link rel="stylesheet" href="/css/site.css" />
    <style>
        body {
            background-color: #111;
            color: #fff;
            font-family: "Segoe UI", sans-serif;
            padding: 40px;
            direction: rtl;
        }
        
        h1 { 
            font-size: 32px; 
            margin-bottom: 20px; 
        }
        
        h2 { 
            margin-top: 40px; 
            border-bottom: 2px solid #333; 
            padding-bottom: 5px; 
            color: #ffd700; 
        }
        
        table {
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px;
            background-color: #1e1e1e; 
            border-radius: 10px; 
            overflow: hidden;
        }
        
        th, td {
            padding: 12px; 
            border-bottom: 1px solid #333; 
            text-align: center;
        }
        
        th { 
            background-color: #222; 
            font-weight: bold; 
        }
        tr:nth-child(even) { background-color: #191919; }
        ul li { margin: 8px 0; }
        ul strong { color: #1e90ff; }
        .back-to-quiz {
            display: inline-block; margin-top: 30px; padding: 10px 20px;
            background-color: #1e90ff; color: white; text-decoration: none;
            border-radius: 8px; font-weight: bold;
        }
        .back-to-quiz:hover { background-color: #0077cc; }
        .background-gif {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0.05; z-index: -1;
        }
    </style>
</head>
<body>
    <a href="/Index" class="back-to-quiz">⬅ חזרה לחידון</a>
    <img src="/assets/background.gif" class="background-gif" alt="רקע" />
    <h1>📊 ממשק ניהול - Dashboard</h1>
    <div style="margin: 10px 0 20px 0;">
        <a href="/Difficulty" class="back-to-quiz" style="background:#ffc107; color:#222;">🔎 רמות קושי</a>
    </div>

    @if (ViewData["SuccessMessage"] != null)
    {
        <div style="background-color:#28a428; padding:12px; border-radius:6px; margin:20px 0; color:white; font-weight:bold; text-align:center;">
            @ViewData["SuccessMessage"]
        </div>
    }

    <h2>✅ סטטיסטיקה כללית <span id="last-update" style="font-size: 14px; color: #888;">(מתעדכן...)</span></h2>
    <ul>
        <li>👥 משתמשים רשומים: <strong id="all-users-count">@Model.AllUsers.Count</strong></li>
        <li>🟢 מחוברים כרגע: <strong id="online-users-count">@Model.OnlineUsers.Count</strong></li>
        <li>🚩 מסומנים כ־Cheaters: <strong id="cheaters-count">@Model.Cheaters.Count</strong></li>
        <li>🔒 חסומים: <strong id="banned-users-count">@Model.BannedUsers.Count</strong></li>
        <li>📈 ממוצע הצלחה: <strong id="average-success-rate">@Model.AverageSuccessRate.ToString("0.0")%</strong></li>
    </ul>

    <h2>📶 משתמשים מחוברים כרגע</h2>
    <table id="online-users-table">
        <tr>
            <th>מיקום</th>
            <th>שם משתמש</th>
            <th>נענו</th>
            <th>נכונות</th>
            <th>הצלחה</th>
        </tr>
        @for (int i = 0; i < Model.OnlineUsers.Count; i++)
        {
            var user = Model.OnlineUsers[i];
            <tr>
                <td>@(i + 1)</td>
                <td>@user.Username</td>
                <td>@user.TotalAnswered</td>
                <td>@user.CorrectAnswers</td>
                <td>@(user.TotalAnswered > 0 ? ((double)user.CorrectAnswers / user.TotalAnswered).ToString("0%") : "N/A")</td>
            </tr>
        }
    </table>

    <h2>🏆 טבלת מובילים</h2>
    <table id="top-users-table">
        <tr>
            <th>מיקום</th>
            <th>שם משתמש</th>
            <th>נענו</th>
            <th>נכונות</th>
            <th>הצלחה</th>
        </tr>
        @for (int i = 0; i < Model.TopUsers.Count; i++)
        {
            var user = Model.TopUsers[i];
            <tr>
                <td>@(i + 1)</td>
                <td>@user.Username</td>
                <td>@user.TotalAnswered</td>
                <td>@user.CorrectAnswers</td>
                <td>@(user.TotalAnswered > 0 ? ((double)user.CorrectAnswers / user.TotalAnswered).ToString("0%") : "N/A")</td>
            </tr>
        }
    </table>

    <h2>🚨 Cheaters</h2>
    <table>
        <tr><th>שם משתמש</th><th>נענו</th><th>נכונות</th><th>הצלחה</th></tr>
        @foreach (var user in Model.Cheaters)
        {
            <tr>
                <td>@user.Username</td>
                <td>@user.TotalAnswered</td>
                <td>@user.CorrectAnswers</td>
                <td>@(user.TotalAnswered > 0 ? ((double)user.CorrectAnswers / user.TotalAnswered).ToString("0%") : "N/A")</td>
            </tr>
        }
    </table>

    <h2>🔒 חסומים</h2>
    <table>
        <tr><th>שם משתמש</th><th>נענו</th><th>נכונות</th><th>הצלחה</th></tr>
        @foreach (var user in Model.BannedUsers)
        {
            <tr>
                <td>@user.Username</td>
                <td>@user.TotalAnswered</td>
                <td>@user.CorrectAnswers</td>
                <td>@(user.TotalAnswered > 0 ? ((double)user.CorrectAnswers / user.TotalAnswered).ToString("0%") : "N/A")</td>
            </tr>
        }
    </table>

</body>

<script>
let updateInterval;

async function fetchDashboardData() {
    try {
        const response = await fetch('/api/dashboard-data?_=' + new Date().getTime());
        const data = await response.json();
        
        // Update statistics
        document.getElementById('all-users-count').textContent = data.allUsersCount;
        document.getElementById('online-users-count').textContent = data.onlineUsersCount;
        document.getElementById('cheaters-count').textContent = data.cheatersCount;
        document.getElementById('banned-users-count').textContent = data.bannedUsersCount;
        document.getElementById('average-success-rate').textContent = data.averageSuccessRate + '%';
        
        // Update online users table
        updateTable('online-users-table', data.onlineUsersList, ['rank', 'username', 'totalAnswered', 'correctAnswers', 'successRate']);
        
        // Update top users table
        updateTable('top-users-table', data.topUsersList, ['rank', 'username', 'totalAnswered', 'correctAnswers', 'successRate']);
        
        // Baseline time; smooth clock updates separately
        window.__dashLastUpdateAt = Date.now();
        
    } catch (error) {
        console.warn('Failed to fetch dashboard data:', error);
        // keep previous time; no clearing
        document.getElementById('last-update').textContent = '(שגיאה בעדכון - מחכה...)';
    }
}

function updateTable(tableId, data, columns) {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    // Keep header row, remove data rows
    const headerRow = table.querySelector('tr');
    table.innerHTML = '';
    table.appendChild(headerRow);
    
    // Add new data rows
    data.forEach((user, index) => {
        const row = table.insertRow();
        
        columns.forEach((column, colIndex) => {
            const cell = row.insertCell();
            if (column === 'rank') {
                cell.textContent = index + 1;
            } else if (column === 'successRate') {
                cell.textContent = user[column] + '%';
            } else {
                cell.textContent = user[column];
            }
        });
    });
}

// Start auto-update every 3 seconds
function startAutoUpdate() {
    updateInterval = setInterval(fetchDashboardData, 200);
    // Smooth clock every 200ms
    if (!window.__dashClockInterval) {
        window.__dashClockInterval = setInterval(() => {
            const el = document.getElementById('last-update');
            if (!el) return;
            const now = new Date();
            el.textContent = `(עודכן ב-${now.toLocaleTimeString('he-IL')})`;
        }, 200);
    }
}

// Stop auto-update
function stopAutoUpdate() {
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
    }
}

// Start updates when page loads
window.addEventListener('load', () => {
    fetchDashboardData(); // Initial load
    startAutoUpdate();
});

// Stop updates when page is hidden (to save resources)
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        stopAutoUpdate();
    } else {
        startAutoUpdate();
    }
});
</script>

@if (Model.AllUsers.Any(u => u.Username == "Admin"))
{
    // הוסרה הצגת דיווחי טעויות בשאלות לפי בקשת המשתמש
}
</html>
