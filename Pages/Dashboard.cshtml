@page
@model NoodlesSimulator.Pages.DashboardModel
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>Noodles Simulator â€” ğŸ”§ ×××©×§ × ×™×”×•×œ</title>
    <link rel="stylesheet" href="/css/site.css" />
    <style>
        body {
            background-color: #111;
            color: #fff;
            font-family: "Segoe UI", sans-serif;
            padding: 40px;
            direction: rtl;
        }
        
        h1 { 
            font-size: 32px; 
            margin-bottom: 20px; 
        }
        
        h2 { 
            margin-top: 40px; 
            border-bottom: 2px solid #333; 
            padding-bottom: 5px; 
            color: #ffd700; 
        }
        
        table {
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px;
            background-color: #1e1e1e; 
            border-radius: 10px; 
            overflow: hidden;
        }
        
        th, td {
            padding: 12px; 
            border-bottom: 1px solid #333; 
            text-align: center;
        }
        
        th { 
            background-color: #222; 
            font-weight: bold; 
        }
        tr:nth-child(even) { background-color: #191919; }
        ul li { margin: 8px 0; }
        ul strong { color: #1e90ff; }
        .back-to-quiz {
            display: inline-block; margin-top: 30px; padding: 10px 20px;
            background-color: #1e90ff; color: white; text-decoration: none;
            border-radius: 8px; font-weight: bold;
        }
        .back-to-quiz:hover { background-color: #0077cc; }
        .background-gif {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0.05; z-index: -1;
        }
    </style>
</head>
<body>
    <a href="/Index" class="back-to-quiz">â¬… ×—×–×¨×” ×œ×—×™×“×•×Ÿ</a>
    <img src="/assets/background.gif" class="background-gif" alt="×¨×§×¢" />
    <h1>ğŸ“Š ×××©×§ × ×™×”×•×œ - Dashboard</h1>

    @if (ViewData["SuccessMessage"] != null)
    {
        <div style="background-color:#28a428; padding:12px; border-radius:6px; margin:20px 0; color:white; font-weight:bold; text-align:center;">
            @ViewData["SuccessMessage"]
        </div>
    }

    <h2>âœ… ×¡×˜×˜×™×¡×˜×™×§×” ×›×œ×œ×™×ª <span id="last-update" style="font-size: 14px; color: #888;">(××ª×¢×“×›×Ÿ...)</span></h2>
    <ul>
        <li>ğŸ‘¥ ××©×ª××©×™× ×¨×©×•××™×: <strong id="all-users-count">@Model.AllUsers.Count</strong></li>
        <li>ğŸŸ¢ ××—×•×‘×¨×™× ×›×¨×’×¢: <strong id="online-users-count">@Model.OnlineUsers.Count</strong></li>
        <li>ğŸš© ××¡×•×× ×™× ×›Ö¾Cheaters: <strong id="cheaters-count">@Model.Cheaters.Count</strong></li>
        <li>ğŸ”’ ×—×¡×•××™×: <strong id="banned-users-count">@Model.BannedUsers.Count</strong></li>
        <li>ğŸ“ˆ ×××•×¦×¢ ×”×¦×œ×—×”: <strong id="average-success-rate">@Model.AverageSuccessRate.ToString("0.0")%</strong></li>
    </ul>

    <h2>ğŸ“¶ ××©×ª××©×™× ××—×•×‘×¨×™× ×›×¨×’×¢</h2>
    <table id="online-users-table">
        <tr>
            <th>××™×§×•×</th>
            <th>×©× ××©×ª××©</th>
            <th>× ×¢× ×•</th>
            <th>× ×›×•× ×•×ª</th>
            <th>×”×¦×œ×—×”</th>
        </tr>
        @for (int i = 0; i < Model.OnlineUsers.Count; i++)
        {
            var user = Model.OnlineUsers[i];
            <tr>
                <td>@(i + 1)</td>
                <td>@user.Username</td>
                <td>@user.TotalAnswered</td>
                <td>@user.CorrectAnswers</td>
                <td>@(user.TotalAnswered > 0 ? ((double)user.CorrectAnswers / user.TotalAnswered).ToString("0%") : "N/A")</td>
            </tr>
        }
    </table>

    <h2>ğŸ† ×˜×‘×œ×ª ××•×‘×™×œ×™×</h2>
    <table id="top-users-table">
        <tr>
            <th>××™×§×•×</th>
            <th>×©× ××©×ª××©</th>
            <th>× ×¢× ×•</th>
            <th>× ×›×•× ×•×ª</th>
            <th>×”×¦×œ×—×”</th>
        </tr>
        @for (int i = 0; i < Model.TopUsers.Count; i++)
        {
            var user = Model.TopUsers[i];
            <tr>
                <td>@(i + 1)</td>
                <td>@user.Username</td>
                <td>@user.TotalAnswered</td>
                <td>@user.CorrectAnswers</td>
                <td>@(user.TotalAnswered > 0 ? ((double)user.CorrectAnswers / user.TotalAnswered).ToString("0%") : "N/A")</td>
            </tr>
        }
    </table>

    <h2>ğŸš¨ Cheaters</h2>
    <table>
        <tr><th>×©× ××©×ª××©</th><th>× ×¢× ×•</th><th>× ×›×•× ×•×ª</th><th>×”×¦×œ×—×”</th></tr>
        @foreach (var user in Model.Cheaters)
        {
            <tr>
                <td>@user.Username</td>
                <td>@user.TotalAnswered</td>
                <td>@user.CorrectAnswers</td>
                <td>@(user.TotalAnswered > 0 ? ((double)user.CorrectAnswers / user.TotalAnswered).ToString("0%") : "N/A")</td>
            </tr>
        }
    </table>

    <h2>ğŸ”’ ×—×¡×•××™×</h2>
    <table>
        <tr><th>×©× ××©×ª××©</th><th>× ×¢× ×•</th><th>× ×›×•× ×•×ª</th><th>×”×¦×œ×—×”</th></tr>
        @foreach (var user in Model.BannedUsers)
        {
            <tr>
                <td>@user.Username</td>
                <td>@user.TotalAnswered</td>
                <td>@user.CorrectAnswers</td>
                <td>@(user.TotalAnswered > 0 ? ((double)user.CorrectAnswers / user.TotalAnswered).ToString("0%") : "N/A")</td>
            </tr>
        }
    </table>

</body>

<script>
let updateInterval;

async function fetchDashboardData() {
    try {
        const response = await fetch('/api/dashboard-data?_=' + new Date().getTime());
        const data = await response.json();
        
        // Update statistics
        document.getElementById('all-users-count').textContent = data.allUsersCount;
        document.getElementById('online-users-count').textContent = data.onlineUsersCount;
        document.getElementById('cheaters-count').textContent = data.cheatersCount;
        document.getElementById('banned-users-count').textContent = data.bannedUsersCount;
        document.getElementById('average-success-rate').textContent = data.averageSuccessRate + '%';
        
        // Update online users table
        updateTable('online-users-table', data.onlineUsersList, ['rank', 'username', 'totalAnswered', 'correctAnswers', 'successRate']);
        
        // Update top users table
        updateTable('top-users-table', data.topUsersList, ['rank', 'username', 'totalAnswered', 'correctAnswers', 'successRate']);
        
        // Baseline time; smooth clock updates separately
        window.__dashLastUpdateAt = Date.now();
        
    } catch (error) {
        console.warn('Failed to fetch dashboard data:', error);
        // keep previous time; no clearing
        document.getElementById('last-update').textContent = '(×©×’×™××” ×‘×¢×“×›×•×Ÿ - ××—×›×”...)';
    }
}

function updateTable(tableId, data, columns) {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    // Keep header row, remove data rows
    const headerRow = table.querySelector('tr');
    table.innerHTML = '';
    table.appendChild(headerRow);
    
    // Add new data rows
    data.forEach((user, index) => {
        const row = table.insertRow();
        
        columns.forEach((column, colIndex) => {
            const cell = row.insertCell();
            if (column === 'rank') {
                cell.textContent = index + 1;
            } else if (column === 'successRate') {
                cell.textContent = user[column] + '%';
            } else {
                cell.textContent = user[column];
            }
        });
    });
}

// Start auto-update every 3 seconds
function startAutoUpdate() {
    updateInterval = setInterval(fetchDashboardData, 200);
    // Smooth clock every 200ms
    if (!window.__dashClockInterval) {
        window.__dashClockInterval = setInterval(() => {
            const el = document.getElementById('last-update');
            if (!el) return;
            const now = new Date();
            el.textContent = `(×¢×•×“×›×Ÿ ×‘-${now.toLocaleTimeString('he-IL')})`;
        }, 200);
    }
}

// Stop auto-update
function stopAutoUpdate() {
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
    }
}

// Start updates when page loads
window.addEventListener('load', () => {
    fetchDashboardData(); // Initial load
    startAutoUpdate();
});

// Stop updates when page is hidden (to save resources)
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        stopAutoUpdate();
    } else {
        startAutoUpdate();
    }
});

// Difficulty filtering functionality
let currentFilter = null;

function filterByDifficulty(difficulty) {
    const rows = document.querySelectorAll('.difficulty-row');
    const titleEl = document.getElementById('difficulty-title');
    const countEl = document.getElementById('difficulty-count');
    
    // Toggle: if clicking the same difficulty, show all
    if (currentFilter === difficulty) {
        currentFilter = null;
        rows.forEach(row => row.style.display = '');
        titleEl.textContent = '×¨×©×™××ª ×©××œ×•×ª (××¢×•×“×›×Ÿ ××•×˜×•××˜×™×ª)';
        countEl.textContent = `××¦×™×’ ××ª ×›×œ ${rows.length} ×”×©××œ×•×ª`;
        
        // Reset card styles
        document.getElementById('difficulty-card-easy').style.opacity = '1';
        document.getElementById('difficulty-card-medium').style.opacity = '1';
        document.getElementById('difficulty-card-hard').style.opacity = '1';
    } else {
        currentFilter = difficulty;
        let visibleCount = 0;
        
        rows.forEach(row => {
            if (row.getAttribute('data-difficulty') === difficulty) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        const diffText = difficulty === 'easy' ? '×§×œ×•×ª' : difficulty === 'medium' ? '×‘×™× ×•× ×™×•×ª' : '×§×©×•×ª';
        titleEl.textContent = `×©××œ×•×ª ${diffText} (${visibleCount} ×©××œ×•×ª)`;
        countEl.textContent = `××¦×™×’ ${visibleCount} ×©××œ×•×ª ${diffText}`;
        
        // Highlight active card
        document.getElementById('difficulty-card-easy').style.opacity = difficulty === 'easy' ? '1' : '0.5';
        document.getElementById('difficulty-card-medium').style.opacity = difficulty === 'medium' ? '1' : '0.5';
        document.getElementById('difficulty-card-hard').style.opacity = difficulty === 'hard' ? '1' : '0.5';
    }
}
</script>

<!-- Difficulty Management Section -->
<h2>ğŸ¯ × ×™×”×•×œ ×¨××•×ª ×§×•×©×™</h2>

@if (TempData["DifficultyMessage"] != null)
{
    <div style="background: #d4edda; border: 2px solid #28a745; padding: 15px; margin: 20px 0; border-radius: 8px;">
        <strong style="color: #155724;">âœ… @TempData["DifficultyMessage"]</strong>
    </div>
}

@if (TempData["DifficultyError"] != null)
{
    <div style="background: #f8d7da; border: 2px solid #dc3545; padding: 15px; margin: 20px 0; border-radius: 8px;">
        <strong style="color: #721c24;">âŒ @TempData["DifficultyError"]</strong>
    </div>
}

<div style="background: #1e1e1e; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
    <div style="margin-bottom: 20px;">
        <h3 style="margin: 0; color: #ffd700;">×¡×™×›×•× ×¨××•×ª ×§×•×©×™</h3>
        <p style="margin: 5px 0; color: #999; font-size: 14px;">
            Easy â‰¥ 65% Â· Medium 35â€“65% Â· Hard &lt; 35%
        </p>
        <p style="margin: 10px 0 0 0; color: #4caf50; font-size: 12px;">
            âš¡ ××¢×•×“×›×Ÿ ××•×˜×•××˜×™×ª ×‘×›×œ ×˜×¢×™× ×ª ×“×£
        </p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
        <div id="difficulty-card-easy" onclick="filterByDifficulty('easy')" 
             style="background: #2d5016; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent;"
             onmouseover="this.style.borderColor='#4caf50'; this.style.transform='scale(1.05)'"
             onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'">
            <div style="font-size: 48px; font-weight: bold; color: #4caf50;">@Model.EasyCount</div>
            <div style="color: #81c784; font-size: 18px; margin-top: 5px;">ğŸŸ¢ ×§×œ×•×ª</div>
        </div>
        <div id="difficulty-card-medium" onclick="filterByDifficulty('medium')" 
             style="background: #4d3800; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent;"
             onmouseover="this.style.borderColor='#ffa726'; this.style.transform='scale(1.05)'"
             onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'">
            <div style="font-size: 48px; font-weight: bold; color: #ffa726;">@Model.MediumCount</div>
            <div style="color: #ffb74d; font-size: 18px; margin-top: 5px;">ğŸŸ¡ ×‘×™× ×•× ×™×•×ª</div>
        </div>
        <div id="difficulty-card-hard" onclick="filterByDifficulty('hard')" 
             style="background: #4d1616; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent;"
             onmouseover="this.style.borderColor='#ef5350'; this.style.transform='scale(1.05)'"
             onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'">
            <div style="font-size: 48px; font-weight: bold; color: #ef5350;">@Model.HardCount</div>
            <div style="color: #e57373; font-size: 18px; margin-top: 5px;">ğŸ”´ ×§×©×•×ª</div>
        </div>
    </div>
    
    @if (Model.DifficultyQuestions.Any())
    {
        <h4 id="difficulty-title" style="margin: 20px 0 10px 0;">×¨×©×™××ª ×©××œ×•×ª (××¢×•×“×›×Ÿ ××•×˜×•××˜×™×ª)</h4>
        <div id="difficulty-table-container" style="max-height: 400px; overflow-y: auto; background: #111; padding: 15px; border-radius: 8px;">
            <table style="width: 100%; font-size: 13px;">
                <thead style="position: sticky; top: 0; background: #222; z-index: 10;">
                    <tr>
                        <th style="text-align: right;">×©××œ×”</th>
                        <th>×¨××ª ×§×•×©×™</th>
                        <th>××—×•×– ×”×¦×œ×—×”</th>
                        <th>× ×™×¡×™×•× ×•×ª</th>
                        <th>× ×›×•× ×•×ª</th>
                        <th>×¢×“×›×•×Ÿ ××—×¨×•×Ÿ</th>
                    </tr>
                </thead>
                <tbody id="difficulty-questions-tbody">
                    @foreach (var q in Model.DifficultyQuestions.Take(500))
                    {
                        var diffColor = q.Difficulty switch
                        {
                            "easy" => "#4caf50",
                            "medium" => "#ffa726",
                            "hard" => "#ef5350",
                            _ => "#999"
                        };
                        var diffText = q.Difficulty switch
                        {
                            "easy" => "×§×œ",
                            "medium" => "×‘×™× ×•× ×™",
                            "hard" => "×§×©×”",
                            _ => q.Difficulty
                        };
                        
                        <tr class="difficulty-row" data-difficulty="@q.Difficulty" style="border-bottom: 1px solid #333;">
                            <td style="text-align: right; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                <span style="display: inline-flex; align-items: center; gap: 8px;">
                                    @q.QuestionFile
                                    <a href="/QuestionView?id=@Uri.EscapeDataString(q.QuestionFile)" 
                                       target="_blank"
                                       title="×”×¦×’ ×©××œ×”"
                                       style="display: inline-flex; align-items: center; color: #4caf50; text-decoration: none; font-size: 16px; transition: all 0.2s;"
                                       onmouseover="this.style.color='#81c784'; this.style.transform='scale(1.2)'"
                                       onmouseout="this.style.color='#4caf50'; this.style.transform='scale(1)'">
                                        ğŸ”
                                    </a>
                                </span>
                            </td>
                            <td>
                                <span style="background: @diffColor; padding: 5px 12px; border-radius: 15px; font-weight: bold; color: white;">
                                    @diffText
                                </span>
                            </td>
                            <td style="font-weight: bold;">@q.SuccessRate.ToString("F1")%</td>
                            <td>@q.TotalAttempts</td>
                            <td>@q.CorrectAttempts</td>
                            <td style="font-size: 11px; color: #999;">@q.LastUpdated.ToLocalTime().ToString("dd/MM HH:mm")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        
        <p id="difficulty-count" style="text-align: center; color: #999; margin-top: 10px;">
            ××¦×™×’ ××ª ×›×œ @Model.DifficultyQuestions.Count ×”×©××œ×•×ª
        </p>
    }
    else
    {
        <div style="text-align: center; padding: 40px; color: #999;">
            <p>××™×Ÿ ×¢×“×™×™×Ÿ × ×ª×•× ×™ ×¨××•×ª ×§×•×©×™ ×‘××¢×¨×›×ª</p>
            <p style="font-size: 14px;">×”×©××œ×•×ª ×™×ª×•×•×¡×¤×• ××•×˜×•××˜×™×ª ×›×©××©×ª××©×™× ×™×¢× ×• ×¢×œ×™×”×Ÿ</p>
        </div>
    }
</div>

@if (Model.AllUsers.Any(u => u.Username == "Admin"))
{
    // ×”×•×¡×¨×” ×”×¦×’×ª ×“×™×•×•×—×™ ×˜×¢×•×™×•×ª ×‘×©××œ×•×ª ×œ×¤×™ ×‘×§×©×ª ×”××©×ª××©
}

<footer class="site-footer">
    <p>
        ×¤×•×ª×— ×¢×´×™ <a href="https://www.linkedin.com/in/yaniv-bahalul/" target="_blank" rel="noopener noreferrer">
            ×™× ×™×‘ ×‘×”×œ×•×œ
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                <rect width="4" height="12" x="2" y="9"></rect>
                <circle cx="4" cy="4" r="2"></circle>
            </svg>
        </a> â€¢ ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª Â©
    </p>
</footer>
</html>
